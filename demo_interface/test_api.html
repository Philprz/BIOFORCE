<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Bioforce</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .test-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            min-height: 20px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>Test de l'API Bioforce</h1>
    
    <div class="test-card">
        <h2>1. Test de connectivité API</h2>
        <p>Vérifie si l'API est accessible (route racine)</p>
        <button onclick="testApiRoot()">Tester la route racine</button>
        <div id="root-result" class="result"></div>
    </div>
    
    <div class="test-card">
        <h2>2. Test de l'API locale</h2>
        <p>Envoie une requête à l'API locale (localhost:8000)</p>
        <button onclick="testLocalApi()">Tester l'API locale</button>
        <div id="local-result" class="result"></div>
    </div>
    
    <div class="test-card">
        <h2>3. Test de l'API déployée</h2>
        <p>Envoie une requête à l'API déployée sur Render</p>
        <button onclick="testDeployedApi()">Tester l'API déployée</button>
        <div id="deployed-result" class="result"></div>
    </div>
    
    <div class="test-card">
        <h2>4. Test du simulateur</h2>
        <p>Vérifie que le mode simulation fonctionne</p>
        <button onclick="testSimulation()">Tester la simulation</button>
        <div id="simulation-result" class="result"></div>
    </div>
    
    <div class="test-card">
        <h2>5. Test avec Proxy CORS</h2>
        <p>Utilise un proxy CORS pour contourner les restrictions</p>
        <button onclick="testWithCorsProxy()">Test via Proxy CORS</button>
        <div id="proxy-result" class="result"></div>
    </div>
    
    <div class="test-card">
        <h2>Problème de sécurité possible</h2>
        <p>Si tous les tests échouent, ouvrez la console du navigateur (F12) pour voir les erreurs détaillées.</p>
        <p><strong>Note:</strong> Si vous accédez à cette page en HTTPS, votre navigateur peut bloquer les requêtes HTTP.</p>
    </div>

    <script>
        // Configuration des URLs
        const API_LOCAL = 'http://localhost:8000';
        const API_PRODUCTION = 'https://bioforce-admin.onrender.com'; // URL correcte de l'API
        const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
        
        // Fonction pour afficher les erreurs de manière plus détaillée
        function handleFetchError(error, resultElement) {
            resultElement.className = 'result error';
            
            if (error.message === 'Failed to fetch') {
                resultElement.innerHTML = `
                    <p>Erreur: ${error.message}</p>
                    <p>Causes possibles:</p>
                    <ul>
                        <li>Le serveur est inaccessible</li>
                        <li>Problème de CORS - vérifiez la configuration du serveur</li>
                        <li>Problème de Mixed Content (HTTP/HTTPS) - vérifiez les protocoles</li>
                        <li>Un pare-feu bloque la connexion</li>
                    </ul>
                    <p>Vérifiez la console du navigateur (F12) pour plus de détails.</p>
                `;
            } else {
                resultElement.innerHTML = `<p>Erreur: ${error.message}</p>`;
            }
        }

        async function testApiRoot() {
            const resultElement = document.getElementById('root-result');
            resultElement.className = 'result';
            resultElement.innerHTML = 'Test en cours...';
            
            try {
                // Afficher l'URL complète pour le débogage
                const url = `${API_LOCAL}/`;
                console.log('Tentative de connexion à:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors', // Mode CORS explicite
                    credentials: 'omit', // Ne pas envoyer de cookies
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                resultElement.className = 'result success';
                resultElement.innerHTML = `<p>Succès ! L'API est accessible.</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                console.error('Erreur testApiRoot:', error);
                handleFetchError(error, resultElement);
            }
        }

        async function testLocalApi() {
            await testApi(API_LOCAL, 'local-result');
        }
        
        async function testDeployedApi() {
            const resultElement = document.getElementById('deployed-result');
            resultElement.className = 'result';
            resultElement.innerHTML = 'Test en cours...';
            
            try {
                console.log('Test de l\'API déployée...');
                
                // Vérifier d'abord si l'API est accessible en mode GET
                console.log('Vérification de l\'accessibilité de l\'API sur', API_PRODUCTION);
                
                try {
                    const pingResponse = await fetch(`${API_PRODUCTION}/`, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (pingResponse.ok) {
                        console.log('L\'API est accessible:', await pingResponse.json());
                    } else {
                        console.warn('L\'API est accessible mais retourne une erreur:', pingResponse.status);
                    }
                } catch (pingError) {
                    console.error('L\'API n\'est pas accessible:', pingError);
                }
                
                // Test complet avec une requête POST
                const testMessage = {
                    user_id: 'test-user-123',
                    messages: [
                        {
                            role: 'user',
                            content: 'Bonjour, pouvez-vous me donner des informations sur Bioforce?'
                        }
                    ],
                    context: {
                        page: '/test_api.html',
                        candidature_id: '00000000'
                    }
                };
                
                console.log(`Envoi de requête à ${API_PRODUCTION}/chat...`);
                
                const response = await fetch(`${API_PRODUCTION}/chat`, {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(testMessage)
                });
                
                console.log('Réponse reçue:', response.status, response.statusText);
                
                const responseText = await response.text();
                console.log('Contenu de la réponse:', responseText);
                
                let data;
                
                try {
                    data = JSON.parse(responseText);
                    resultElement.className = 'result success';
                    resultElement.innerHTML = `<p>Succès ! Code: ${response.status}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`;
                } catch (jsonError) {
                    resultElement.className = 'result error';
                    resultElement.innerHTML = `<p>Réponse reçue mais format incorrect. Code: ${response.status}</p>
                        <pre>${responseText}</pre>`;
                }
            } catch (error) {
                console.error('Erreur testDeployedApi:', error);
                
                let errorMsg = `
                    <p>Erreur: ${error.message}</p>
                    <p>Causes possibles:</p>
                    <ul>
                        <li>L'API sur Render n'est pas accessible</li>
                        <li>Problème de CORS - vérifiez que l'API est bien configurée pour accepter les requêtes depuis votre domaine</li>
                        <li>Vérifiez dans la console du navigateur (F12) pour plus de détails</li>
                    </ul>
                    <p>Solutions possibles:</p>
                    <ul>
                        <li>Déployez la version corrigée de l'API sur Render</li>
                        <li>Vérifiez que l'URL "${API_PRODUCTION}" est correcte</li>
                        <li>Essayez d'accéder directement à <a href="${API_PRODUCTION}" target="_blank">${API_PRODUCTION}</a> pour vérifier si l'API répond</li>
                    </ul>
                `;
                
                resultElement.className = 'result error';
                resultElement.innerHTML = errorMsg;
            }
        }
        
        async function testApi(apiUrl, resultId) {
            const resultElement = document.getElementById(resultId);
            resultElement.className = 'result';
            resultElement.innerHTML = 'Test en cours...';
            
            const testMessage = {
                user_id: 'test-user-123',
                messages: [
                    {
                        role: 'user',
                        content: 'Bonjour, pouvez-vous me donner des informations sur Bioforce?'
                    }
                ],
                context: {
                    page: '/test_api.html',
                    candidature_id: '00000000'
                }
            };
            
            try {
                console.log(`Envoi de requête à ${apiUrl}/chat...`);
                
                const response = await fetch(`${apiUrl}/chat`, {
                    method: 'POST',
                    mode: 'cors', // Mode CORS explicite
                    credentials: 'omit', // Ne pas envoyer de cookies
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(testMessage)
                });
                
                console.log('Réponse reçue:', response.status, response.statusText);
                
                const responseText = await response.text();
                console.log('Contenu de la réponse:', responseText);
                
                let data;
                
                try {
                    data = JSON.parse(responseText);
                    resultElement.className = 'result success';
                    resultElement.innerHTML = `<p>Succès ! Code: ${response.status}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`;
                } catch (jsonError) {
                    resultElement.className = 'result error';
                    resultElement.innerHTML = `<p>Réponse reçue mais format incorrect. Code: ${response.status}</p>
                        <pre>${responseText}</pre>`;
                }
            } catch (error) {
                console.error('Erreur testApi:', error);
                handleFetchError(error, resultElement);
            }
        }
        
        function testSimulation() {
            const resultElement = document.getElementById('simulation-result');
            resultElement.className = 'result success';
            
            const simulatedResponses = [
                "Bonjour ! Je suis ravi de vous accueillir sur le site de Bioforce. Comment puis-je vous aider aujourd'hui ?",
                "Bioforce est une organisation humanitaire qui propose des formations pour les professionnels du secteur humanitaire.",
                "Pour candidater, vous devez soumettre un dossier complet via notre plateforme en ligne.",
                "Nos formations sont disponibles dans plusieurs domaines : logistique, management de projet, eau et assainissement, et bien d'autres."
            ];
            
            const randomResponse = simulatedResponses[Math.floor(Math.random() * simulatedResponses.length)];
            
            resultElement.innerHTML = `<p>Mode simulation activé</p>
                <pre>${randomResponse}</pre>`;
        }
        
        async function testWithCorsProxy() {
            const resultElement = document.getElementById('proxy-result');
            resultElement.className = 'result';
            resultElement.innerHTML = 'Test en cours via proxy CORS...';
            
            try {
                console.log('Test via proxy CORS...');
                
                // URL avec proxy CORS
                const proxiedUrl = `${CORS_PROXY}${API_PRODUCTION}`;
                console.log('URL avec proxy:', proxiedUrl);
                
                // Test d'accessibilité via le proxy
                try {
                    const pingResponse = await fetch(`${proxiedUrl}/`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (pingResponse.ok) {
                        const pingData = await pingResponse.json();
                        console.log('API accessible via proxy:', pingData);
                        
                        // Si l'API est accessible, essayons une requête chat
                        const testMessage = {
                            user_id: 'test-user-123',
                            messages: [
                                {
                                    role: 'user',
                                    content: 'Bonjour, pouvez-vous me donner des informations sur Bioforce?'
                                }
                            ],
                            context: {
                                page: '/test_api.html',
                                candidature_id: '00000000'
                            }
                        };
                        
                        const response = await fetch(`${proxiedUrl}/chat`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'Origin': 'http://localhost'
                            },
                            body: JSON.stringify(testMessage)
                        });
                        
                        const responseText = await response.text();
                        console.log('Réponse via proxy:', responseText);
                        
                        try {
                            const data = JSON.parse(responseText);
                            resultElement.className = 'result success';
                            resultElement.innerHTML = `
                                <p>Succès via proxy CORS ! Code: ${response.status}</p>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                                <p><strong>Note:</strong> Votre API semble fonctionner correctement, mais les en-têtes CORS ne sont pas configurés. Vous devez déployer les modifications de configuration CORS sur Render.</p>
                            `;
                        } catch (jsonError) {
                            resultElement.className = 'result warning';
                            resultElement.innerHTML = `
                                <p>Réponse reçue mais format incorrect. Code: ${response.status}</p>
                                <pre>${responseText}</pre>
                            `;
                        }
                    } else {
                        resultElement.className = 'result error';
                        resultElement.innerHTML = `
                            <p>L'API est accessible via le proxy mais renvoie une erreur: ${pingResponse.status}</p>
                            <p>Contenu: ${await pingResponse.text()}</p>
                        `;
                    }
                } catch (error) {
                    resultElement.className = 'result error';
                    resultElement.innerHTML = `
                        <p>Erreur avec le proxy CORS: ${error.message}</p>
                        <p>Le proxy CORS-Anywhere nécessite parfois une autorisation. Essayez d'accéder à <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">https://cors-anywhere.herokuapp.com/corsdemo</a> et de demander un accès temporaire.</p>
                    `;
                }
                
            } catch (error) {
                console.error('Erreur générale proxy test:', error);
                resultElement.className = 'result error';
                resultElement.innerHTML = `<p>Erreur: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
