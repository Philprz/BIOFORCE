<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Bioforce</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .test-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            min-height: 20px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>Test de l'API Bioforce</h1>
    
    <div class="test-card">
        <h2>1. Test de connectivité API</h2>
        <p>Vérifie si l'API est accessible (route racine)</p>
        <button onclick="testApiRoot()">Tester la route racine</button>
        <div id="root-result" class="result"></div>
    </div>
    
    <div class="test-card">
        <h2>2. Test de l'API locale</h2>
        <p>Envoie une requête à l'API locale (localhost:8000)</p>
        <button onclick="testLocalApi()">Tester l'API locale</button>
        <div id="local-result" class="result"></div>
    </div>
    
    <div class="test-card">
        <h2>3. Test de l'API déployée</h2>
        <p>Envoie une requête à l'API déployée sur Render</p>
        <button onclick="testDeployedApi()">Tester l'API déployée</button>
        <div id="deployed-result" class="result"></div>
    </div>
    
    <div class="test-card">
        <h2>4. Test du simulateur</h2>
        <p>Vérifie que le mode simulation fonctionne</p>
        <button onclick="testSimulation()">Tester la simulation</button>
        <div id="simulation-result" class="result"></div>
    </div>

    <script>
        // Configuration des URLs
        const API_LOCAL = 'http://localhost:8000';
        const API_PRODUCTION = 'https://bioforce-api.onrender.com'; // Modifier avec l'URL réelle

        async function testApiRoot() {
            const resultElement = document.getElementById('root-result');
            resultElement.className = 'result';
            resultElement.innerHTML = 'Test en cours...';
            
            try {
                const response = await fetch(`${API_LOCAL}/`);
                const data = await response.json();
                
                resultElement.className = 'result success';
                resultElement.innerHTML = `<p>Succès ! L'API est accessible.</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                resultElement.className = 'result error';
                resultElement.innerHTML = `<p>Erreur: ${error.message}</p>`;
            }
        }

        async function testLocalApi() {
            await testApi(API_LOCAL, 'local-result');
        }
        
        async function testDeployedApi() {
            await testApi(API_PRODUCTION, 'deployed-result');
        }
        
        async function testApi(apiUrl, resultId) {
            const resultElement = document.getElementById(resultId);
            resultElement.className = 'result';
            resultElement.innerHTML = 'Test en cours...';
            
            const testMessage = {
                user_id: 'test-user-123',
                messages: [
                    {
                        role: 'user',
                        content: 'Bonjour, pouvez-vous me donner des informations sur Bioforce?'
                    }
                ],
                context: {
                    page: '/test_api.html',
                    candidature_id: '00000000'
                }
            };
            
            try {
                const response = await fetch(`${apiUrl}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testMessage)
                });
                
                const responseText = await response.text();
                let data;
                
                try {
                    data = JSON.parse(responseText);
                    resultElement.className = 'result success';
                    resultElement.innerHTML = `<p>Succès ! Code: ${response.status}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`;
                } catch (jsonError) {
                    resultElement.className = 'result error';
                    resultElement.innerHTML = `<p>Réponse reçue mais format incorrect. Code: ${response.status}</p>
                        <pre>${responseText}</pre>`;
                }
            } catch (error) {
                resultElement.className = 'result error';
                resultElement.innerHTML = `<p>Erreur: ${error.message}</p>`;
            }
        }
        
        function testSimulation() {
            const resultElement = document.getElementById('simulation-result');
            resultElement.className = 'result success';
            
            const simulatedResponses = [
                "Bonjour ! Je suis ravi de vous accueillir sur le site de Bioforce. Comment puis-je vous aider aujourd'hui ?",
                "Bioforce est une organisation humanitaire qui propose des formations pour les professionnels du secteur humanitaire.",
                "Pour candidater, vous devez soumettre un dossier complet via notre plateforme en ligne.",
                "Nos formations sont disponibles dans plusieurs domaines : logistique, management de projet, eau et assainissement, et bien d'autres."
            ];
            
            const randomResponse = simulatedResponses[Math.floor(Math.random() * simulatedResponses.length)];
            
            resultElement.innerHTML = `<p>Mode simulation activé</p>
                <pre>${randomResponse}</pre>`;
        }
    </script>
</body>
</html>
